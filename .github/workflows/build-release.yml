name: Build & Release PrepareEwonSD

on:
  push:
    branches: [ "main" ]
    paths:
      - "scripts/Prepare_Ewon_SD.ps1"
      - ".github/workflows/build-release.yml"
    tags:
      - "v*"
  workflow_dispatch:
    inputs:
      version:
        description: "Version for the binary (e.g. 3.3.3)"
        required: false
        type: string

jobs:
  build:
    runs-on: windows-latest

    steps:
      - name: "Checkout"
        uses: actions/checkout@v4

      - name: "Determine version"
        id: ver
        shell: pwsh
        run: |
          if ('${{ github.event.inputs.version }}') {
            $v = '${{ github.event.inputs.version }}'
          } elseif ("${{ github.ref }}".StartsWith("refs/tags/")) {
            $tag = "${{ github.ref }}".Substring("refs/tags/".Length)
            $v = $tag.TrimStart('v')
          } else {
            $sha = "${{ github.sha }}".Substring(0,7)
            $v = "dev-$sha"
          }
          "version=$v" | Out-File -FilePath $env:GITHUB_OUTPUT -Encoding utf8 -Append
          Write-Host "Version: $v"

      - name: "Sanity check - source present"
        shell: pwsh
        run: |
          if (-not (Test-Path "scripts/Prepare_Ewon_SD.ps1")) {
            Get-ChildItem -Recurse | Select-Object FullName
            throw "scripts/Prepare_Ewon_SD.ps1 not found."
          }
          Get-Item "scripts/Prepare_Ewon_SD.ps1" | Format-List *

      - name: "Prepare dist folder"
        shell: pwsh
        run: New-Item -ItemType Directory -Path dist -Force | Out-Null

      - name: "Generate C# wrapper from PS1 (embedded Base64)"
        shell: pwsh
        run: |
          $ErrorActionPreference = 'Stop'
          $version = '${{ steps.ver.outputs.version }}'
          $ps1Path = "scripts/Prepare_Ewon_SD.ps1"
          $b64 = [Convert]::ToBase64String([IO.File]::ReadAllBytes($ps1Path))

          $cs = @"
          using System;
          using System.Diagnostics;
          using System.IO;
          using System.Reflection;
          using System.Text;

          [assembly: AssemblyTitle("Preparation Carte SD Ewon Flexy")]
          [assembly: AssemblyProduct("Preparation Carte SD Ewon Flexy")]
          [assembly: AssemblyCompany("Clauger")]
          [assembly: AssemblyDescription("Tool to prepare SD card for Ewon Flexy (public, no secrets).")]
          [assembly: AssemblyVersion("0.0.0.0")] // replaced at link time below if needed

          namespace Wrapper
          {
              internal static class Program
              {
                  [STAThread]
                  private static int Main(string[] args)
                  {
                      try
                      {
                          string base64 = @"{B64}";
                          byte[] bytes = Convert.FromBase64String(base64);
                          string scriptPath = Path.Combine(Path.GetTempPath(), "Prepare_Ewon_SD.ps1");
                          File.WriteAllBytes(scriptPath, bytes);

                          // Run with Windows PowerShell for max compatibility
                          var psi = new ProcessStartInfo
                          {
                              FileName = "powershell.exe",
                              Arguments = "-NoProfile -ExecutionPolicy Bypass -File \"" + scriptPath + "\"",
                              UseShellExecute = false
                          };

                          var p = Process.Start(psi);
                          p.WaitForExit();
                          return p.ExitCode;
                      }
                      catch (Exception ex)
                      {
                          // Fallback: write error to a temp log and pause
                          string log = Path.Combine(Path.GetTempPath(), "Prepare_Ewon_SD_wrapper_error.txt");
                          File.WriteAllText(log, ex.ToString(), Encoding.UTF8);
                          try
                          {
                              Console.Error.WriteLine("Wrapper error. See: " + log);
                              Console.Error.WriteLine(ex.ToString());
                              Console.Error.WriteLine("Press Enter to exit...");
                              Console.ReadLine();
                          } catch {}
                          return 1;
                      }
                  }
              }
          }
          "@
          $cs = $cs.Replace("{B64}", $b64)
          Set-Content -Path "wrapper.cs" -Value $cs -Encoding UTF8

          Write-Host "Generated wrapper.cs:"
          Get-Item wrapper.cs | Format-List *

      - name: "Compile C# wrapper to EXE (.NET Framework csc.exe)"
        shell: pwsh
        run: |
          $ErrorActionPreference = 'Stop'
          $version = '${{ steps.ver.outputs.version }}'
          $out = "dist/PrepareEwonSD_v$version.exe"

          # Try Framework64 first, then Framework (x86) as fallback
          $csc64 = "$env:WINDIR\Microsoft.NET\Framework64\v4.0.30319\csc.exe"
          $csc86 = "$env:WINDIR\Microsoft.NET\Framework\v4.0.30319\csc.exe"
          $csc = if (Test-Path $csc64) { $csc64 } elseif (Test-Path $csc86) { $csc86 } else { $null }
          if (-not $csc) { throw "csc.exe not found on runner." }

          Write-Host "Using compiler: $csc"
          # /target:winexe => no extra console window; use /target:exe if you prefer a console
          & $csc /nologo /target:winexe /platform:anycpu /out:$out wrapper.cs

          Write-Host "dist content:"
          Get-ChildItem dist -Recurse | Format-Table -AutoSize

          if (-not (Test-Path $out)) { throw "EXE not generated: $out" }

      - name: "Locate built EXE"
        id: findexe
        shell: pwsh
        run: |
          $exe = Get-ChildItem -Path dist -Filter *.exe -Recurse | Select-Object -First 1
          if (-not $exe) { throw "EXE not found in dist/" }
          "file=$($exe.FullName)" | Out-File -FilePath $env:GITHUB_OUTPUT -Encoding utf8 -Append
          Write-Host "EXE: $($exe.FullName)"

      - name: "Upload build artifact"
        uses: actions/upload-artifact@v4
        with:
          name: PrepareEwonSD_${{ steps.ver.outputs.version }}
          path: ${{ steps.findexe.outputs.file }}
          if-no-files-found: error

  release:
    if: startsWith(github.ref, 'refs/tags/')
    needs: [ build ]
    runs-on: ubuntu-latest

    steps:
      - name: "Download artifacts"
        uses: actions/download-artifact@v4
        with:
          path: dist

      - name: "Find EXE"
        id: findexe
        run: |
          EXE=$(ls dist/**/*.exe | head -n 1)
          if [ -z "$EXE" ]; then
            echo "EXE not found"; exit 1
          fi
          echo "file=$EXE" >> $GITHUB_OUTPUT

      - name: "Create GitHub Release"
        uses: softprops/action-gh-release@v2
        with:
          files: ${{ steps.findexe.outputs.file }}
          generate_release_notes: true
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
